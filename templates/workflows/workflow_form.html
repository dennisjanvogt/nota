{% extends 'base_modern.html' %}
{% load static %}

{% block title %}{{ title }} - Notariatskammer{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-top">
        <div>
            <h1 class="page-title">
                <i class="bi bi-diagram-3"></i> {{ title }}
            </h1>
        </div>
    </div>
</div>

<div style="max-width: 800px; margin: 0 auto;">
    <!-- Info Card -->
    <div class="card" style="margin-bottom: var(--spacing-lg); border-left: 4px solid var(--secondary-blue);">
        <div class="card-body">
            <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                <div style="color: var(--secondary-blue); font-size: 24px;">
                    <i class="bi bi-info-circle"></i>
                </div>
                <div>
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">Workflow erstellen</div>
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        Nach dem Erstellen wird der Workflow als Entwurf gespeichert. Sie kÃ¶nnen ihn dann starten,
                        um die einzelnen Schritte zu aktivieren.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Card -->
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <!-- Workflow-Typ -->
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md); color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-sm);">
                    Workflow-Typ
                </h3>

                <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                    <label class="form-label">{{ form.workflow_typ.label }} *</label>
                    {{ form.workflow_typ }}
                    {% if form.workflow_typ.help_text %}
                    <small style="display: block; margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
                        {{ form.workflow_typ.help_text }}
                    </small>
                    {% endif %}
                    {% if form.workflow_typ.errors %}
                    <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">
                        {{ form.workflow_typ.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Grunddaten -->
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md); color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-sm);">
                    Grunddaten
                </h3>

                <div class="form-group" style="margin-bottom: var(--spacing-md);">
                    <label class="form-label">{{ form.name.label }} *</label>
                    {{ form.name }}
                    {% if form.name.help_text %}
                    <small style="display: block; margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
                        {{ form.name.help_text }}
                    </small>
                    {% endif %}
                    {% if form.name.errors %}
                    <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">
                        {{ form.name.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Betroffene Personen mit Autocomplete -->
                <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                    <label class="form-label">Betroffene Personen</label>
                    <div style="position: relative;">
                        <input type="text" id="person-search" class="form-control" placeholder="ðŸ” Person suchen und hinzufÃ¼gen..." autocomplete="off">
                        <div id="autocomplete-results" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: var(--radius-sm); margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: var(--shadow-lg);"></div>
                    </div>
                    <small style="display: block; margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
                        Tippen Sie, um Notare oder Kandidaten zu suchen
                    </small>
                </div>

                <!-- AusgewÃ¤hlte Personen (Chips) -->
                <div id="selected-persons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: var(--spacing-lg); min-height: 40px; padding: 12px; background: var(--bg-primary); border-radius: var(--radius-sm); border: 1px dashed var(--border-color);">
                    <span style="color: var(--text-secondary); font-size: 14px; align-self: center;">Keine Personen ausgewÃ¤hlt</span>
                </div>

                <!-- Verstecktes Feld fÃ¼r IDs -->
                {{ form.betroffene_personen_ids }}

                <!-- Notizen -->
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md); color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-sm);">
                    Notizen
                </h3>

                <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                    <label class="form-label">{{ form.notizen.label }}</label>
                    {{ form.notizen }}
                    {% if form.notizen.help_text %}
                    <small style="display: block; margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
                        {{ form.notizen.help_text }}
                    </small>
                    {% endif %}
                    {% if form.notizen.errors %}
                    <div style="color: var(--danger); font-size: 13px; margin-top: 4px;">
                        {{ form.notizen.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Buttons -->
                <div style="display: flex; justify-content: space-between; gap: var(--spacing-md); margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                    <a href="{% url 'workflow_liste' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Abbrechen
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> {{ submit_text }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Autocomplete fÃ¼r Personensuche
(function() {
    const searchInput = document.getElementById('person-search');
    const resultsDiv = document.getElementById('autocomplete-results');
    const selectedDiv = document.getElementById('selected-persons');
    const hiddenInput = document.getElementById('id_betroffene_personen_ids');

    let selectedPersons = [];
    let searchTimeout = null;

    // Suchfeld Event-Handler
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();

        clearTimeout(searchTimeout);

        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`{% url 'personen_autocomplete_api' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    showResults(data);
                })
                .catch(error => {
                    console.error('Autocomplete error:', error);
                });
        }, 300);
    });

    // Suchergebnisse anzeigen
    function showResults(results) {
        if (results.length === 0) {
            resultsDiv.style.display = 'none';
            return;
        }

        resultsDiv.innerHTML = '';

        results.forEach(person => {
            // Skip if already selected
            if (selectedPersons.find(p => p.id === person.id)) {
                return;
            }

            const item = document.createElement('div');
            item.style.cssText = 'padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;';
            item.innerHTML = `
                <div style="width: 32px; height: 32px; border-radius: 50%; background: ${person.typ === 'notar' ? 'var(--primary-orange)' : 'var(--secondary-blue)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                    ${person.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 14px;">${person.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        ${person.typ === 'notar' ? 'ðŸŸ  Notar' : 'ðŸ”µ Kandidat'}
                        ${person.zusatz ? ' â€¢ ' + person.zusatz : ''}
                    </div>
                </div>
            `;

            item.addEventListener('mouseenter', function() {
                this.style.background = 'var(--bg-primary)';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
            item.addEventListener('click', function() {
                addPerson(person);
            });

            resultsDiv.appendChild(item);
        });

        resultsDiv.style.display = 'block';
    }

    // Person hinzufÃ¼gen
    function addPerson(person) {
        // Check if already added
        if (selectedPersons.find(p => p.id === person.id)) {
            return;
        }

        selectedPersons.push(person);
        renderSelectedPersons();
        updateHiddenInput();

        // Clear search
        searchInput.value = '';
        resultsDiv.style.display = 'none';
    }

    // Person entfernen
    function removePerson(personId) {
        selectedPersons = selectedPersons.filter(p => p.id !== personId);
        renderSelectedPersons();
        updateHiddenInput();
    }

    // AusgewÃ¤hlte Personen rendern
    function renderSelectedPersons() {
        if (selectedPersons.length === 0) {
            selectedDiv.innerHTML = '<span style="color: var(--text-secondary); font-size: 14px; align-self: center;">Keine Personen ausgewÃ¤hlt</span>';
            return;
        }

        selectedDiv.innerHTML = '';

        selectedPersons.forEach(person => {
            const chip = document.createElement('div');
            chip.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 6px 12px;
                background: ${person.typ === 'notar' ? 'var(--primary-orange)' : 'var(--secondary-blue)'};
                color: white;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
            `;
            chip.innerHTML = `
                <span>${person.typ === 'notar' ? 'ðŸŸ ' : 'ðŸ”µ'} ${person.name}</span>
                <button type="button" onclick="event.preventDefault()" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; font-size: 16px; line-height: 1;">Ã—</button>
            `;

            const removeBtn = chip.querySelector('button');
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                removePerson(person.id);
            });

            selectedDiv.appendChild(chip);
        });
    }

    // Hidden input aktualisieren
    function updateHiddenInput() {
        const ids = selectedPersons.map(p => `${p.typ}:${p.id}`).join(',');
        hiddenInput.value = ids;
    }

    // Click outside schlieÃŸt Autocomplete
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
})();
</script>
{% endblock %}
