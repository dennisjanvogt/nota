{% extends 'base_modern.html' %}

{% block title %}DMS - Notariatskammer{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; margin-bottom: 24px;">
    <div>
        <h1 style="font-size: 24px; font-weight: 600; margin: 0;">
            <i class="bi bi-folder2-open"></i> Dokumentenmanagementsystem (DMS)
        </h1>
    </div>
</div>

<!-- Filter Modal -->
<div id="filterModal" class="modal" onclick="closeFilterModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Filter & Suche</h2>
            <button type="button" class="btn-close" onclick="closeFilterModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="get" id="filterForm">
                <div class="form-group">
                    <label class="form-label">Suche</label>
                    <input type="text" name="suche" class="form-control"
                           placeholder="Titel..." value="{{ suche }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Dokumenttyp</label>
                    <select name="typ" class="form-control">
                        <option value="">Alle</option>
                        <option value="brief" {% if typ_filter == 'brief' %}selected{% endif %}>Brief</option>
                        <option value="beschluss" {% if typ_filter == 'beschluss' %}selected{% endif %}>Beschluss</option>
                        <option value="protokoll" {% if typ_filter == 'protokoll' %}selected{% endif %}>Protokoll</option>
                        <option value="sonstiges" {% if typ_filter == 'sonstiges' %}selected{% endif %}>Sonstiges</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="{% url 'dms' %}" class="btn btn-secondary">
                <i class="bi bi-x"></i>
                Zurücksetzen
            </a>
            <button type="submit" form="filterForm" class="btn btn-primary">
                <i class="bi bi-search"></i>
                Filtern
            </button>
        </div>
    </div>
</div>

<!-- Dokumente-Liste -->
<div class="card">
    <div class="card-header" style="padding: 18px 24px; margin: calc(-1 * var(--spacing-xl)) calc(-1 * var(--spacing-xl)) 0 calc(-1 * var(--spacing-xl)); border-radius: var(--radius-lg) var(--radius-lg) 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h5 class="mb-0">
            <i class="bi bi-files"></i> Dokumente
        </h5>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="openFilterModal()">
                <i class="bi bi-funnel"></i>
                <span id="filterButtonText">Filter</span>
            </button>
            <span class="badge bg-primary" style="font-size: 14px; padding: 6px 12px;">{{ page_obj.paginator.count }}</span>
        </div>
    </div>
    <div class="card-body p-0" style="margin: 0 calc(-1 * var(--spacing-xl));">
        {% if page_obj %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Titel</th>
                        <th>Typ</th>
                        <th>Service</th>
                        <th>Erstellt von</th>
                        <th>Datum</th>
                        <th style="width: 120px;">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dokument in page_obj %}
                    <tr>
                        <td>
                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                            <strong>{{ dokument.titel }}</strong>
                            {% if dokument.beschreibung %}
                            <br>
                            <small class="text-muted">{{ dokument.beschreibung|truncatewords:10 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ dokument.get_dokument_typ_display }}
                            </span>
                        </td>
                        <td>
                            {% if dokument.generiert_von_service %}
                            {{ dokument.generiert_von_service.service.name }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if dokument.generiert_von_service %}
                            {{ dokument.generiert_von_service.ausgefuehrt_von.get_full_name|default:dokument.generiert_von_service.ausgefuehrt_von.username }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {{ dokument.erstellt_am|date:"d.m.Y H:i" }}
                            <br>
                            <small class="text-muted">{{ dokument.erstellt_am|timesince }} her</small>
                        </td>
                        <td style="white-space: nowrap;">
                            <button type="button" class="btn btn-sm btn-primary" title="Vorschau" style="margin-right: 4px;" onclick="showPdfPreview('{{ dokument.datei.url }}', '{{ dokument.titel|escapejs }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <a href="{{ dokument.datei.url }}" download class="btn btn-sm btn-secondary" title="Herunterladen">
                                <i class="bi bi-download"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer" style="margin: 0 calc(-1 * var(--spacing-xl)) calc(-1 * var(--spacing-xl)) calc(-1 * var(--spacing-xl)); border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">
                            Seite {{ page_obj.number }} von {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl);">
            <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
            <p class="text-muted mt-3">Noch keine Dokumente vorhanden.</p>
            <p class="small text-muted">
                Dokumente werden automatisch erstellt, wenn Sie Services ausführen.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
    </a>
</div>

<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="pdf-modal-overlay" onclick="closePdfPreview(event)">
    <div class="pdf-modal-content" onclick="event.stopPropagation()">
        <div class="pdf-modal-header">
            <h5 class="pdf-modal-title">
                <i class="bi bi-file-earmark-pdf" style="color: var(--danger);"></i>
                <span id="pdfTitle">Dokument</span>
            </h5>
            <button type="button" class="pdf-modal-close" onclick="closePdfPreview()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="pdf-modal-body">
            <iframe id="pdfFrame" src="about:blank"></iframe>
        </div>
        <div class="pdf-modal-footer">
            <a id="pdfDownloadBtn" href="" download class="btn btn-primary">
                <i class="bi bi-download"></i> Herunterladen
            </a>
            <a id="pdfOpenBtn" href="" target="_blank" class="btn btn-secondary">
                <i class="bi bi-box-arrow-up-right"></i> In neuem Tab öffnen
            </a>
            <button type="button" class="btn btn-secondary" onclick="closePdfPreview()">
                <i class="bi bi-x"></i> Schließen
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Filter Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal > .modal-content {
        background-color: var(--bg-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
    }

    .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .modal-body {
        padding: var(--spacing-lg);
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        color: var(--text-secondary);
    }

    .btn-close:hover {
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        font-size: 14px;
        color: var(--text-primary);
    }

    .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 14px;
        background: var(--bg-elevated);
        color: var(--text-primary);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    /* PDF Preview Modal - Separate styling */
    .pdf-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .pdf-modal-overlay.show {
        display: flex;
    }

    .pdf-modal-content {
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 1200px;
        height: 90vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .pdf-modal-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-elevated);
        flex-shrink: 0;
    }

    .pdf-modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .pdf-modal-close {
        background: var(--bg-hover);
        border: 1px solid var(--border-color);
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .pdf-modal-close:hover {
        background: var(--danger-bg);
        border-color: var(--danger);
        color: var(--danger);
    }

    .pdf-modal-body {
        flex: 1;
        overflow: hidden;
        background: #525659;
        display: flex;
    }

    .pdf-modal-body iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .pdf-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: var(--bg-elevated);
        flex-shrink: 0;
    }

    /* Table fixes */
    .table .text-muted {
        color: var(--text-muted) !important;
    }

    .table .text-danger {
        color: var(--danger) !important;
    }

    .table .bg-secondary {
        background: var(--bg-elevated) !important;
        color: var(--text-primary) !important;
    }

    .table .bg-primary {
        background: var(--primary-gradient) !important;
    }

    /* Pagination */
    .pagination .page-item .page-link {
        background: var(--bg-surface) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    .pagination .page-item:hover .page-link {
        background: var(--bg-hover) !important;
    }

    .pagination .page-item.disabled .page-link {
        background: var(--bg-elevated) !important;
        color: var(--text-muted) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Filter Modal Functions
function openFilterModal() {
    document.getElementById('filterModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeFilterModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('filterModal').classList.remove('show');
    document.body.style.overflow = '';
}

function updateFilterButtonText() {
    const urlParams = new URLSearchParams(window.location.search);
    let activeFilters = 0;

    if (urlParams.get('suche')) activeFilters++;
    if (urlParams.get('typ')) activeFilters++;

    const buttonText = document.getElementById('filterButtonText');
    if (activeFilters > 0) {
        buttonText.textContent = `Filter (${activeFilters})`;
    } else {
        buttonText.textContent = 'Filter';
    }
}

// Initial update
document.addEventListener('DOMContentLoaded', function() {
    updateFilterButtonText();
});

// ESC key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFilterModal();
    }
});

// PDF Preview Functions
function showPdfPreview(pdfUrl, title) {
    const modal = document.getElementById('pdfPreviewModal');
    const pdfFrame = document.getElementById('pdfFrame');
    const pdfTitle = document.getElementById('pdfTitle');
    const pdfDownloadBtn = document.getElementById('pdfDownloadBtn');
    const pdfOpenBtn = document.getElementById('pdfOpenBtn');

    // Daten setzen
    pdfTitle.textContent = title;
    pdfFrame.src = pdfUrl;
    pdfDownloadBtn.href = pdfUrl;
    pdfOpenBtn.href = pdfUrl;

    // Modal anzeigen
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closePdfPreview(event) {
    if (event && event.target !== event.currentTarget) return;

    const modal = document.getElementById('pdfPreviewModal');
    const pdfFrame = document.getElementById('pdfFrame');

    modal.classList.remove('show');
    document.body.style.overflow = '';

    // PDF aus iframe entfernen (Performance)
    setTimeout(() => {
        pdfFrame.src = 'about:blank';
    }, 300);
}

// ESC key schließt auch PDF Modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePdfPreview();
    }
});
</script>
{% endblock %}
